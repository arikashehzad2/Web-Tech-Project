<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assignment 2 — Single Page CRUD</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
      .spinner-container {
        display: none;
      }
      .pointer {
        cursor: pointer;
      }
      .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1080;
      }
      textarea.form-control {
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <h2 class="mb-3">Single Page CRUD — Stories</h2>

      <div class="d-flex gap-2 mb-3">
        <button id="refreshBtn" class="btn btn-primary">Refresh Stories</button>
        <div class="spinner-container align-self-center" id="spinnerWrap">
          <div
            class="spinner-border spinner-border-sm"
            role="status"
            aria-hidden="true"
          ></div>
          <small class="ms-2">Loading...</small>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-4">
          <div class="card">
            <div class="card-header" id="formHeader">Create New Story</div>
            <div class="card-body">
              <form id="storyForm">
                <input type="hidden" id="editingId" value="" />
                <div class="mb-3">
                  <label for="title" class="form-label">Title</label>
                  <input id="title" class="form-control" required />
                </div>
                <div class="mb-3">
                  <label for="content" class="form-label">Content</label>
                  <textarea
                    id="content"
                    rows="5"
                    class="form-control"
                    required
                  ></textarea>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-success" id="saveBtn">
                    Save
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="cancelEditBtn"
                    style="display: none"
                  >
                    Cancel Edit
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card">
            <div class="card-header">Stories</div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped mb-0" id="storiesTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 6%">ID</th>
                      <th style="width: 22%">Title</th>
                      <th>Content</th>
                      <th style="width: 18%">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      $(function () {
        const baseURL = "https://usmanlive.com/wp-json/api/stories";
        const $spinner = $("#spinnerWrap");
        const $tableBody = $("#storiesTable tbody");
        const $form = $("#storyForm");
        const $title = $("#title");
        const $content = $("#content");
        const $editingId = $("#editingId");
        const $formHeader = $("#formHeader");
        const $cancelEditBtn = $("#cancelEditBtn");

        function showToast(message, isSuccess = true) {
          const id = "t" + Date.now();
          const toastHTML = `
          <div id="${id}" class="toast align-items-center text-bg-${
            isSuccess ? "success" : "danger"
          } border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>`;
          $("#toastContainer").append(toastHTML);
          const toastEl = document.getElementById(id);
          const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
          bsToast.show();

          toastEl.addEventListener("hidden.bs.toast", () =>
            $(toastEl).remove()
          );
        }

        function showSpinner(show) {
          $spinner.toggle(show);
        }

        function createRow(item) {
          const $row = $(`
          <tr data-id="${item.id}">
            <td>${item.id}</td>
            <td class="title-col"></td>
            <td class="content-col"></td>
            <td>
              <button class="btn btn-sm btn-primary edit-btn">Edit</button>
              <button class="btn btn-sm btn-danger delete-btn">Delete</button>
            </td>
          </tr>
        `);
          $row.find(".title-col").text(item.title);
          $row.find(".content-col").text(item.content);
          return $row;
        }

        function fetchStories() {
          showSpinner(true);
          $tableBody.empty();
          $.get(baseURL)
            .done(function (data) {
              if (!Array.isArray(data)) data = [];
              data.forEach((item) => {
                $tableBody.append(createRow(item));
              });
              attachRowHandlers();
              showToast("Stories loaded", true);
            })
            .fail(function (xhr, status, err) {
              showToast(
                "Failed to load stories: " + (xhr.statusText || status),
                false
              );
            })
            .always(function () {
              showSpinner(false);
            });
        }

        function attachRowHandlers() {
          $tableBody
            .find(".edit-btn")
            .off("click")
            .on("click", function () {
              const id = $(this).closest("tr").data("id");
              startEdit(id);
            });

          $tableBody
            .find(".delete-btn")
            .off("click")
            .on("click", function () {
              const id = $(this).closest("tr").data("id");
              deleteStory(id);
            });
        }

        function createStory(data) {
          showSpinner(true);
          $.post(baseURL, data)
            .done(function (created) {
              $tableBody.prepend(createRow(created));
              attachRowHandlers();
              $form[0].reset();
              showToast("Story created", true);
            })
            .fail(function (xhr) {
              showToast(
                "Failed to create story: " + (xhr.statusText || "Error"),
                false
              );
            })
            .always(function () {
              showSpinner(false);
            });
        }

        // start editing: prefill form
        function startEdit(id) {
          // Option: fetch single story or read from table. We'll fetch single to be safe.
          showSpinner(true);
          $.get(baseURL + "/" + id)
            .done(function (item) {
              $editingId.val(item.id);
              $title.val(item.title);
              $content.val(item.content);
              $formHeader.text("Edit Story (ID: " + item.id + ")");
              $("#saveBtn").text("Update");
              $cancelEditBtn.show();
              showToast("Prefilled edit form", true);
            })
            .fail(function () {
              showToast("Failed to fetch story for edit", false);
            })
            .always(function () {
              showSpinner(false);
            });
        }

        // update story (PUT)
        function updateStory(id, data) {
          showSpinner(true);
          $.ajax({
            url: baseURL + "/" + id,
            method: "PUT",
            data: data,
          })
            .done(function (updated) {
              // find row and update its content
              const $row = $tableBody.find('tr[data-id="' + id + '"]');
              if ($row.length) {
                $row.find(".title-col").text(updated.title);
                $row.find(".content-col").text(updated.content);
              } else {
                // if not exists, prepend
                $tableBody.prepend(createRow(updated));
                attachRowHandlers();
              }
              resetFormState();
              showToast("Story updated", true);
            })
            .fail(function () {
              showToast("Failed to update story", false);
            })
            .always(function () {
              showSpinner(false);
            });
        }

        // delete story (DELETE)
        function deleteStory(id) {
          if (!confirm("Are you sure you want to delete story ID " + id + "?"))
            return;
          showSpinner(true);
          $.ajax({
            url: baseURL + "/" + id,
            method: "DELETE",
          })
            .done(function () {
              // remove row from DOM
              $tableBody.find('tr[data-id="' + id + '"]').remove();
              showToast("Story deleted", true);
            })
            .fail(function () {
              showToast("Failed to delete story", false);
            })
            .always(function () {
              showSpinner(false);
            });
        }

        // reset form from edit state to create
        function resetFormState() {
          $editingId.val("");
          $form[0].reset();
          $formHeader.text("Create New Story");
          $("#saveBtn").text("Save");
          $cancelEditBtn.hide();
        }

        // Form submit handler (create or update)
        $form.on("submit", function (e) {
          e.preventDefault();
          const id = $editingId.val().trim();
          const payload = {
            title: $title.val().trim(),
            content: $content.val().trim(),
          };

          // minimal validation
          if (!payload.title || !payload.content) {
            showToast("Please fill title and content", false);
            return;
          }

          if (id) {
            // update
            updateStory(id, payload);
          } else {
            // create
            createStory(payload);
          }
        });

        // Cancel edit
        $cancelEditBtn.on("click", function () {
          resetFormState();
        });

        // Refresh button
        $("#refreshBtn").on("click", function () {
          fetchStories();
        });

        // Initial load
        fetchStories();
      });
    </script>
  </body>
</html>
